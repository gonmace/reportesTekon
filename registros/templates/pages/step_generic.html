{% load static %}
{% load registro_urls %}
{% load map_filters %}

<li>
  {% if not first %}
  <hr class="bg-white sombra" />
  {% endif %}
  
  <!-- Título del step -->
  <div class="timeline-start timeline-box text-lg mr-4">
    {{step.title|title}}
  </div>
  
  <!-- Botón del formulario o círculo blanco -->
  <div class="timeline-middle">
    {% if step.elements.form %}
    <a href="{{step.elements.form.url}}"
      class="btn btn-{{step.elements.form.color}} btn-circle p-1 sombra"
      title="Editar {{step.title}}">
      {% include 'svgs/notes.svg' %}
    </a>
    {% else %}
    <div class="btn btn-circle btn-disabled p-1 sombra bg-white border-2 border-gray-300"></div>
    {% endif %}
        
  </div>
  
  <!-- Elementos adicionales -->
  <div class="timeline-end text-lg">
    <div class="flex items-start gap-2">
      
      <!-- Fotos -->
      {% if step.elements.photos.enabled %}
        <div class="flex items-center gap-1 ml-2">
          <a class="btn btn-{{step.elements.photos.color}} btn-circle sombra photo-counter" 
             href="{% get_registro_photos_url step.step_name step.registro_id app_namespace='reg_txtss' %}"
             title="Fotos de {{step.title}}"
             data-photo-count="{{step.elements.photos.count}}"
             data-photo-required="{% if step.elements.photos.required %}true{% else %}false{% endif %}"
             data-photo-min-count="{{step.elements.photos.min_count}}">
            {% include 'svgs/photo-camera.svg' %}
          </a>
        </div>
      {% endif %}
      
      <!-- Mapa -->
      {% if step.elements.map.enabled %}
        <div class="flex items-center gap-1 ml-2">
          <button id="map-btn-{{step.step_name}}" 
                  class="btn btn-{{step.elements.map.status}} btn-circle sombra"
                  title="Mapa de {{step.title}}"
                  {% if step.elements.map.coordinates.coord1 %}
                  data-coord1-lat="{{step.elements.map.coordinates.coord1.lat}}" 
                  data-coord1-lon="{{step.elements.map.coordinates.coord1.lon}}" 
                  data-coord1-label="{{step.elements.map.coordinates.coord1.label}}"
                  data-coord1-color="{{step.elements.map.coordinates.coord1.color}}"
                  data-coord1-size="{{step.elements.map.coordinates.coord1.size}}"
                  {% else %}
                  {% endif %}
                  {% if step.elements.map.coordinates.coord2 %}
                  data-coord2-lat="{{step.elements.map.coordinates.coord2.lat}}" 
                  data-coord2-lon="{{step.elements.map.coordinates.coord2.lon}}" 
                  data-coord2-label="{{step.elements.map.coordinates.coord2.label}}"
                  data-coord2-color="{{step.elements.map.coordinates.coord2.color}}"
                  data-coord2-size="{{step.elements.map.coordinates.coord2.size}}"
                  {% endif %}
                  {% if step.elements.map.coordinates.coord3 %}
                  data-coord3-lat="{{step.elements.map.coordinates.coord3.lat}}" 
                  data-coord3-lon="{{step.elements.map.coordinates.coord3.lon}}" 
                  data-coord3-label="{{step.elements.map.coordinates.coord3.label}}"
                  data-coord3-color="{{step.elements.map.coordinates.coord3.color}}"
                  data-coord3-size="{{step.elements.map.coordinates.coord3.size}}"
                  {% endif %}
                  data-site-registro="{{step.registro_id}}"
                  data-step-title="{{step.title}}"
                  data-etapa="{{step.elements.map.etapa}}"
                  data-map-type="{% if step.elements.map.coordinates.coord2 or step.elements.map.coordinates.coord3 %}multi{% else %}single{% endif %}">
            {% include 'svgs/map-marker.svg' %}
          </button>
        </div>
      {% endif %}
      
    </div>
  </div>
  
  {% if not last %}
  <hr class="bg-white sombra" />
  {% endif %}
</li>

<!-- Modal genérico para mostrar mapas (solo se incluye una vez) -->
{% if forloop.first %}
  {% include 'components/mapa_modal.html' %}
{% endif %}