{% extends "base.html" %}

{% load static %} 

{% block pre_content %}
    {% include 'components/common/breadcrumbs.html' %}
{% endblock pre_content %}

{% block content %}

{% if allow_multiple_per_site %}
<!-- Selector de fecha para m√∫ltiples registros del mismo sitio -->
<div class="mb-6 p-4 bg-base-100 rounded-lg shadow-sm border sombra">
    <div class="flex flex-col md:flex-row items-center justify-between gap-4">
        <div class="flex items-center gap-2">
            <span class="text-sm font-medium text-base-content">Seleccionar fecha:</span>
            <span class="text-xs text-base-content/60">(Hoy para nueva fecha, fechas existentes para navegar)</span>
        </div>
        <div class="flex items-center gap-2">
            <select id="fecha-selector" class="select select-bordered select-sm" onchange="cambiarRegistro(this.value)">
                <!-- Opci√≥n para fecha de hoy -->
                <option value="hoy" style="font-weight: bold; color: #3b82f6;">
                    üóìÔ∏è Hoy ({{ "now"|date:"d/m/Y" }})
                </option>
                <!-- Separador -->
                <option value="" disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
                <!-- Registros existentes -->
                {% for reg in registros_sitio %}
                    <option value="{{ reg.id }}" {% if reg.id == registro.id %}selected{% endif %}>
                        {{ reg.fecha|date:"d/m/Y" }} {% if reg.id == registro.id %}(Actual){% endif %}
                    </option>
                {% endfor %}
            </select>
            <button class="btn btn-primary btn-sm" id="activar-registro-btn" type="button">
                <i class="fa-solid fa-plus"></i>
                Nueva Fecha
            </button>
        </div>
    </div>
</div>
{% endif %}

<!-- Bot√≥n de PDF -->
{% if pdf_url %}
<div class="mb-4 flex justify-end">
    <a href="{{ pdf_url }}" target="_blank" class="btn btn-secondary btn-sm" title="Generar PDF">
        <i class="fa-solid fa-file-pdf"></i>
        PDF
    </a>
</div>
{% endif %}

<ul class="timeline timeline-vertical">
    {% for step_name, step in steps %}
        {% include 'pages/step_generic.html' with step=step first=forloop.first last=forloop.last %}
    {% endfor %}
</ul>

<!-- Leyenda de colores -->
<div class="mt-8 p-4 bg-base-100 rounded-lg shadow-sm border sombra">
    <div class="flex justify-between flex-col md:flex-row items-center">

        <div class="flex flex-col w-full mb-2">
            <h3 class="font-bold">Leyenda de colores</h3>
            <!-- Error - Rojo -->
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 rounded-full bg-error"></div>
                <span class="text-sm text-base-content">Sin Datos</span>
            </div>
            
            <!-- Warning - Amarillo -->
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 rounded-full bg-warning"></div>
                <span class="text-sm text-base-content">Parciales</span>
            </div>
            
            <!-- Success - Verde -->
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 rounded-full bg-success"></div>
                <span class="text-sm text-base-content">Completos</span>
            </div>
        </div>

        <div class="flex flex-col w-full my-2 md:my-0 md:mb-auto">
        {% for step_name, step in steps %}
            {% if step.datos_clave_template %}
                    {% include step.datos_clave_template %}
            {% endif %}
        {% endfor %}
        </div>

        
    </div>
</div>

<!-- Modal para activar registro -->
{% include 'components/activar_registro_form.html' %}

<script>
function cambiarRegistro(registroId) {
    if (registroId === 'hoy') {
        // Si selecciona "Hoy", abrir el modal para crear un nuevo registro con fecha de hoy
        const modal = document.getElementById('activar-registro-modal');
        const activarBtn = document.getElementById('activar-registro-btn');
        if (activarBtn && modal) {
            activarBtn.click();
        }
    } else if (registroId) {
        // Si selecciona un registro existente, navegar a √©l
        window.location.href = '/{{ app_namespace }}/' + registroId + '/';
    }
}

// Configuraci√≥n para el modal de activaci√≥n
window.ACTIVAR_URL = '{% url app_namespace|add:":activar" %}';
window.MODAL_ID = '#activar-registro-modal';
window.ACTIVAR_BTN_ID = '#activar-registro-btn';
window.SITIO_ACTUAL = {{ registro.sitio.id }};
window.USUARIO_ACTUAL = {{ registro.user.id }};
window.FECHA_ACTUAL = '{{ registro.fecha|date:"Y-m-d" }}';

// Inicializar modal cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('activar-registro-modal');
    const activarBtn = document.getElementById('activar-registro-btn');
    const sitioSelect = document.getElementById('id_sitio');
    
    if (activarBtn && modal) {
        activarBtn.addEventListener('click', function(e) {
            e.preventDefault();
            modal.showModal();
            
            // Pre-seleccionar el sitio actual
            if (sitioSelect && window.SITIO_ACTUAL) {
                sitioSelect.value = window.SITIO_ACTUAL;
            }
            
            // Pre-seleccionar el usuario actual
            const userSelect = document.getElementById('id_user');
            if (userSelect && window.USUARIO_ACTUAL) {
                userSelect.value = window.USUARIO_ACTUAL;
            }
            
            // Pre-seleccionar la fecha actual
            const fechaInput = document.getElementById('id_fecha');
            if (fechaInput) {
                // Siempre usar la fecha actual cuando se abre el modal
                const today = new Date().toISOString().split('T')[0];
                fechaInput.value = today;
            }
        });
    }
    
    // Funci√≥n global para cerrar modal
    window.closeModal = function() {
        modal.close();
    };
    
    // Manejar env√≠o del formulario
    const form = modal.querySelector('form');
    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(form);
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            try {
                const response = await fetch(window.ACTIVAR_URL, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    modal.close();
                    alert(result.message || 'Registro activado exitosamente');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    const errorMessage = result.message || 'Error al activar el registro';
                    alert(errorMessage);
                }
            } catch (error) {
                console.error('Error en la petici√≥n:', error);
                alert('Error al crear el registro. Por favor, int√©ntalo de nuevo.');
            }
        });
    }
});
</script>
{% endblock %} 