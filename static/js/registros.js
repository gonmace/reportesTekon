import{D as h}from"./assets/convertCoords-D60ha3dX.js";const o=window.Alert;h.ext.classes.container="dt-container table table-sm !table-zebra w-full";h.ext.classes.thead={row:"bg-accent text-white uppercase"};document.addEventListener("DOMContentLoaded",function(){const f=document.querySelector("#registros-table");if(f){let p=function(){const i=new h("#registros-table",{ajax:{url:"/txtss/api/v1/registros/",dataSrc:""},columns:[{data:"sitio.pti_cell_id",className:"!text-center"},{data:"sitio.operator_id",className:"!text-center"},{data:"sitio.name",className:"w-fit max-w-40"},{data:"user.username",className:"!text-center",width:"150px",render:function(e,r,s){if(r==="display")if(d){let t='<div class="ito-cell-container">';return t+='<span class="ito-text" style="cursor: pointer;" data-registro-id="'+s.id+'">',t+=(e||"Sin asignar")+' <i class="fa-solid fa-pen-to-square text-xs text-warning ml-1"></i></span>',t+='<select class="ito-select select select-warning select-sm select-bordered w-full max-w-full" style="display: none;" data-registro-id="'+s.id+'">',t+='<option value="">Seleccionar ITO</option>',n.forEach(l=>{const b=s.user&&s.user.id===l.id?"selected":"";t+='<option value="'+l.id+'" '+b+">"+l.username+"</option>"}),t+="</select></div>",t}else return e||"Sin asignar";return e||"Sin asignar"}},...d?[{data:null,orderable:!1,className:"text-center",render:function(e,r,s){return`
                                <a 
                                    type="button"
                                    href="/txtss/registros/${e.id}/"
                                    class="btn btn-lg btn-success btn-circle text-lg sombra"
                                    data-id="${s.is_deleted.id}" 
                                    title="${s.sitio.name}"
                                >
                                    <i class="fa-regular fa-pen-to-square"></i>
                                </a>
                            `}}]:[]],responsive:!0,pageLength:10,order:[[1,"asc"]],dom:'rt<"flex justify-between items-center"<"info"i><"length"l><"pagination"p>>',language:{search:"_INPUT_",searchPlaceholder:"Buscar...",lengthMenu:"_MENU_ Registros",info:"_START_ al _END_ de _TOTAL_ ",infoEmpty:"0 al 0 de 0",infoFiltered:"(filtrado de _MAX_ registros)"},autoWidth:!1,bStateSave:!0}),v=document.getElementById("buscadorPersonalizado");v&&v.addEventListener("keyup",function(){i.search(this.value).draw()}),d&&(f.addEventListener("click",function(e){if(e.target.classList.contains("ito-text")){e.target.dataset.registroId;const r=e.target.closest("td"),s=e.target,t=r.querySelector(".ito-select");s.style.display="none",t.style.display="block",t.focus()}}),f.addEventListener("change",function(e){if(e.target.classList.contains("ito-select")){const r=e.target.dataset.registroId,s=e.target.value,t=e.target.closest("td"),l=t.querySelector(".ito-text"),b=e.target,w=document.querySelector("[name=csrfmiddlewaretoken]").value,y=i.row(t.closest("tr")).data();fetch(`/txtss/api/v1/registros/${r}/`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRFToken":w},body:JSON.stringify({sitio_id:y.sitio.id,user_id:s,is_deleted:y.is_deleted})}).then(c=>{if(c.ok)return c.json();throw new Error("Error en la actualización")}).then(c=>{const u=n.find(a=>a.id==s);l.innerHTML=(u?u.username:"Sin asignar")+' <i class="fa-solid fa-pen-to-square text-xs text-gray-400 ml-1"></i>',b.style.display="none",l.style.display="inline",o.success("ITO actualizado exitosamente",{autoHide:3e3,dismissible:!0})}).catch(c=>{console.error("Error:",c);const u=n.find(a=>a.id==y.user.id);l.innerHTML=(u?u.username:"Sin asignar")+' <i class="fa-solid fa-pen-to-square text-xs text-gray-400 ml-1"></i>',b.style.display="none",l.style.display="inline",c.response?c.response.json().then(a=>{a.errors&&a.errors.non_field_errors?o.error(a.errors.non_field_errors[0],{autoHide:0,dismissible:!0}):a.message?o.error(a.message,{autoHide:0,dismissible:!0}):o.error("Error al actualizar ITO. Por favor, inténtalo de nuevo.",{autoHide:0,dismissible:!0})}).catch(()=>{o.error("Error al actualizar ITO. Por favor, inténtalo de nuevo.",{autoHide:0,dismissible:!0})}):o.error("Error al actualizar ITO. Por favor, inténtalo de nuevo.",{autoHide:0,dismissible:!0})})}}),f.addEventListener("blur",function(e){if(e.target.classList.contains("ito-select")){const s=e.target.closest("td").querySelector(".ito-text"),t=e.target;setTimeout(()=>{t.style.display="none",s.style.display="inline"},200)}},!0))};const d=window.isSuperuser||!1;let n=[];fetch("/txtss/api/v1/registros/usuarios_ito/").then(i=>i.json()).then(i=>{n=i,p()}).catch(i=>{console.error("Error cargando usuarios ITO:",i),p()})}const m=document.getElementById("activar-registro-modal"),x=document.getElementById("activar-registro-btn");x&&m&&x.addEventListener("click",function(){console.log("activarBtn"),m.showModal()}),window.closeModal=function(){m.close()};const E=document.getElementById("activar-registro-btn");E&&E.addEventListener("click",function(){console.log("activarRegistroBtn")});const g=document.querySelector("#activar-registro-modal form");g&&g.addEventListener("submit",function(d){d.preventDefault();const n=new FormData(g),p=n.get("sitio"),i=n.get("user");if(!p||!i){o.error("Por favor completa todos los campos requeridos.",{autoHide:3e3,dismissible:!0});return}const v=document.querySelector("[name=csrfmiddlewaretoken]").value;fetch(g.action,{method:"POST",headers:{"X-CSRFToken":v,"X-Requested-With":"XMLHttpRequest"},body:n}).then(e=>{if(e.ok)return e.json();throw new Error("Error en la petición")}).then(e=>{if(console.log("Respuesta del servidor:",e),e.success)m.close(),o.success(e.message||"Registro activado exitosamente",{autoHide:3e3}),setTimeout(()=>{window.location.reload()},1e3);else throw new Error(e.message||"Error al activar el registro")}).catch(e=>{console.error("Error:",e),e.response?e.response.json().then(r=>{r.errors&&r.errors.non_field_errors?o.error(r.errors.non_field_errors[0],{autoHide:0,dismissible:!0}):r.message?o.error(r.message,{autoHide:0,dismissible:!0}):o.error("Error al crear el registro. Por favor, inténtalo de nuevo.",{autoHide:0,dismissible:!0})}).catch(()=>{o.error("Error al crear el registro. Por favor, inténtalo de nuevo.",{autoHide:0,dismissible:!0})}):o.error("Error al crear el registro. Por favor, inténtalo de nuevo.",{autoHide:0,dismissible:!0})})})});
