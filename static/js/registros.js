import{D as h}from"./assets/convertCoords-D60ha3dX.js";const o=window.Alert;h.ext.classes.container="dt-container table table-sm !table-zebra w-full";h.ext.classes.thead={row:"bg-accent text-white uppercase"};document.addEventListener("DOMContentLoaded",function(){const g=document.querySelector("#registros-table");if(g){let v=function(){const e=new h("#registros-table",{ajax:{url:"/txtss/api/v1/registros/",dataSrc:""},columns:[{data:"sitio.pti_cell_id",className:"!text-center"},{data:"sitio.operator_id",className:"!text-center"},{data:"sitio.name",className:"w-fit max-w-40"},{data:"user.username",className:"!text-center",width:"150px",render:function(t,c,r){if(c==="display")if(u){let s='<div class="ito-cell-container">';return s+='<span class="ito-text" style="cursor: pointer;" data-registro-id="'+r.id+'">',s+=(t||"Sin asignar")+' <i class="fa-solid fa-pen-to-square text-xs text-warning ml-1"></i></span>',s+='<select class="ito-select select select-warning select-sm select-bordered w-full max-w-full" style="display: none;" data-registro-id="'+r.id+'">',s+='<option value="">Seleccionar ITO</option>',n.forEach(l=>{const y=r.user&&r.user.id===l.id?"selected":"";s+='<option value="'+l.id+'" '+y+">"+l.username+"</option>"}),s+="</select></div>",s}else return t||"Sin asignar";return t||"Sin asignar"}},...u?[{data:null,orderable:!1,className:"text-center",render:function(t,c,r){return`
                                <a 
                                    type="button"
                                    href="/txtss/registros/${t.id}/"
                                    class="btn btn-lg btn-success btn-circle text-lg sombra"
                                    data-id="${r.is_deleted.id}" 
                                    title="${r.sitio.name}"
                                >
                                    <i class="fa-regular fa-pen-to-square"></i>
                                </a>
                            `}}]:[]],responsive:!0,pageLength:10,order:[[1,"asc"]],dom:'rt<"flex justify-between items-center"<"info"i><"length"l><"pagination"p>>',language:{search:"_INPUT_",searchPlaceholder:"Buscar...",lengthMenu:"_MENU_ Registros",info:"_START_ al _END_ de _TOTAL_ ",infoEmpty:"0 al 0 de 0",infoFiltered:"(filtrado de _MAX_ registros)"},autoWidth:!1,bStateSave:!0}),a=document.getElementById("buscadorPersonalizado");a&&a.addEventListener("keyup",function(){e.search(this.value).draw()}),u&&(g.addEventListener("click",function(t){if(t.target.classList.contains("ito-text")){t.target.dataset.registroId;const c=t.target.closest("td"),r=t.target,s=c.querySelector(".ito-select");r.style.display="none",s.style.display="block",s.focus()}}),g.addEventListener("change",function(t){if(t.target.classList.contains("ito-select")){const c=t.target.dataset.registroId,r=t.target.value,s=t.target.closest("td"),l=s.querySelector(".ito-text"),y=t.target,_=document.querySelector("[name=csrfmiddlewaretoken]").value,b=e.row(s.closest("tr")).data();fetch(`/txtss/api/v1/registros/${c}/`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRFToken":_},body:JSON.stringify({sitio_id:b.sitio.id,user_id:r,is_deleted:b.is_deleted})}).then(d=>{if(d.ok)return d.json();throw new Error("Error en la actualización")}).then(d=>{const f=n.find(i=>i.id==r);l.innerHTML=(f?f.username:"Sin asignar")+' <i class="fa-solid fa-pen-to-square text-xs text-gray-400 ml-1"></i>',y.style.display="none",l.style.display="inline",o.success("ITO actualizado exitosamente",{autoHide:3e3,dismissible:!0})}).catch(d=>{console.error("Error:",d);const f=n.find(i=>i.id==b.user.id);l.innerHTML=(f?f.username:"Sin asignar")+' <i class="fa-solid fa-pen-to-square text-xs text-gray-400 ml-1"></i>',y.style.display="none",l.style.display="inline",d.response?d.response.json().then(i=>{i.errors&&i.errors.non_field_errors?o.error(i.errors.non_field_errors[0],{autoHide:0,dismissible:!0}):i.message?o.error(i.message,{autoHide:0,dismissible:!0}):o.error("Error al actualizar ITO. Por favor, inténtalo de nuevo.",{autoHide:0,dismissible:!0})}).catch(()=>{o.error("Error al actualizar ITO. Por favor, inténtalo de nuevo.",{autoHide:0,dismissible:!0})}):o.error("Error al actualizar ITO. Por favor, inténtalo de nuevo.",{autoHide:0,dismissible:!0})})}}),g.addEventListener("blur",function(t){if(t.target.classList.contains("ito-select")){const r=t.target.closest("td").querySelector(".ito-text"),s=t.target;setTimeout(()=>{s.style.display="none",r.style.display="inline"},200)}},!0))};const u=window.isSuperuser||!1;let n=[];fetch("/txtss/api/v1/registros/usuarios_ito/").then(e=>e.json()).then(e=>{n=e,v()}).catch(e=>{console.error("Error cargando usuarios ITO:",e),v()})}const m=document.getElementById("activar-registro-modal"),x=document.getElementById("activar-registro-btn");x&&m&&x.addEventListener("click",function(){console.log("activarBtn"),m.showModal()}),window.closeModal=function(){m.close()};const E=document.getElementById("activar-registro-btn");E&&E.addEventListener("click",function(){console.log("activarRegistroBtn")});const p=document.querySelector("#activar-registro-modal form");p&&p.addEventListener("submit",function(u){u.preventDefault();const n=new FormData(p);n.get("sitio"),n.get("user");const v=document.querySelector("[name=csrfmiddlewaretoken]").value;fetch(p.action,{method:"POST",headers:{"X-CSRFToken":v,"X-Requested-With":"XMLHttpRequest"},body:n}).then(e=>{if(e.ok)return e.json();throw new Error("Error en la petición")}).then(e=>e.json()).then(e=>{if(console.log("Respuesta del servidor:",e),e.success)m.close(),o.success(e.message||"Registro activado exitosamente",{autoHide:3e3}),setTimeout(()=>{window.location.reload()},1e3);else throw new Error(e.message||"Error al activar el registro")}).catch(e=>{console.error("Error:",e),e.response?e.response.json().then(a=>{a.errors&&a.errors.non_field_errors?o.error(a.errors.non_field_errors[0],{autoHide:0,dismissible:!0}):a.message?o.error(a.message,{autoHide:0,dismissible:!0}):o.error("Error al crear el registro. Por favor, inténtalo de nuevo.",{autoHide:0,dismissible:!0})}).catch(()=>{o.error("Error al crear el registro. Por favor, inténtalo de nuevo.",{autoHide:0,dismissible:!0})}):o.error("Error al crear el registro. Por favor, inténtalo de nuevo.",{autoHide:0,dismissible:!0})})})});
