import{D as c}from"./assets/convertCoords-D60ha3dX.js";const l=window.Alert;c.ext.classes.container="dt-container table table-sm !table-zebra w-full";c.ext.classes.thead={row:"bg-accent text-white uppercase"};const f={apiBaseUrl:window.API_BASE_URL||"/txtss/api/v1/",registrosUrl:window.REGISTROS_URL||"/txtss/api/v1/registros/",usuariosUrl:window.USUARIOS_URL||"/txtss/api/v1/usuarios/usuarios_ito/",activarUrl:window.ACTIVAR_URL||"/txtss/activar/",tableId:window.TABLE_ID||"#registros-table",pageLength:window.PAGE_LENGTH||10,isSuperuser:window.isSuperuser||!1,columns:window.TABLE_COLUMNS||[{data:"sitio.pti_cell_id",className:"!text-center",title:"PTI ID"},{data:"sitio.operator_id",className:"!text-center",title:"Operador ID"},{data:"sitio.name",className:"w-fit max-w-40",title:"Nombre Sitio"},{data:"user.username",className:"!text-center",width:"150px",title:"ITO",editable:!0}],showActions:window.SHOW_ACTIONS!==!1,actionsUrl:window.ACTIONS_URL||"/txtss/registros/",language:{search:"_INPUT_",searchPlaceholder:"Buscar...",lengthMenu:"_MENU_ Registros",info:"_START_ al _END_ de _TOTAL_ ",infoEmpty:"0 al 0 de 0",infoFiltered:"(filtrado de _MAX_ registros)"}};class m{constructor(t={}){this.config={...f,...t},this.usuariosIto=[],this.tabla=null,this.init()}async init(){try{await this.cargarUsuariosIto(),this.inicializarTabla(),this.configurarEventos()}catch(t){console.error("Error inicializando tabla:",t),this.inicializarTabla(),this.configurarEventos()}}async cargarUsuariosIto(){try{const t=await fetch(this.config.usuariosUrl);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);this.usuariosIto=await t.json()}catch(t){console.error("Error cargando usuarios ITO:",t),this.usuariosIto=[]}}inicializarTabla(){const t=this.config.columns.map(e=>e.data==="user.username"&&this.config.isSuperuser?{...e,render:(s,i,r)=>this.renderItoCell(s,i,r)}:e);this.config.showActions&&this.config.isSuperuser&&t.push({data:null,orderable:!1,className:"text-center",render:(e,s,i)=>this.renderActionsCell(e,s,i)}),this.tabla=new c(this.config.tableId,{ajax:{url:this.config.registrosUrl,dataSrc:""},columns:t,responsive:!0,pageLength:this.config.pageLength,order:[[1,"asc"]],dom:'rt<"flex justify-between items-center"<"info"i><"length"l><"pagination"p>>',language:this.config.language,autoWidth:!1,bStateSave:!0}),this.configurarBuscador()}renderItoCell(t,e,s){if(e==="display")if(this.config.isSuperuser){let i='<div class="ito-cell-container">';return i+='<span class="ito-text" style="cursor: pointer;" data-registro-id="'+s.id+'">',i+=(t||"Sin asignar")+' <i class="fa-solid fa-pen-to-square text-xs text-warning ml-1"></i></span>',i+='<select class="ito-select select select-warning select-sm select-bordered w-full max-w-full" style="display: none;" data-registro-id="'+s.id+'">',i+='<option value="">Seleccionar ITO</option>',this.usuariosIto.forEach(r=>{const a=s.user&&s.user.id===r.id?"selected":"";i+='<option value="'+r.id+'" '+a+">"+r.username+"</option>"}),i+="</select></div>",i}else return t||"Sin asignar";return t||"Sin asignar"}renderActionsCell(t,e,s){return`
            <a 
                type="button"
                href="${this.config.actionsUrl}${s.id}/"
                class="btn btn-lg btn-success btn-circle text-lg sombra"
                data-id="${s.id}" 
                title="${s.sitio.name}"
            >
                <i class="fa-regular fa-pen-to-square"></i>
            </a>
        `}configurarBuscador(){const t=document.getElementById("buscadorPersonalizado");t&&this.tabla&&t.addEventListener("keyup",(function(){this.tabla.search(this.value).draw()}).bind(this))}configurarEventos(){if(!this.config.isSuperuser)return;const t=document.querySelector(this.config.tableId);t&&(t.addEventListener("click",e=>{e.target.classList.contains("ito-text")&&this.mostrarSelect(e.target)}),t.addEventListener("change",e=>{e.target.classList.contains("ito-select")&&this.actualizarIto(e.target)}),t.addEventListener("blur",e=>{e.target.classList.contains("ito-select")&&this.ocultarSelect(e.target)},!0))}mostrarSelect(t){t.dataset.registroId;const s=t.closest("td").querySelector(".ito-select");t.style.display="none",s.style.display="block",s.focus()}ocultarSelect(t){const s=t.closest("td").querySelector(".ito-text");setTimeout(()=>{t.style.display="none",s.style.display="inline"},200)}async actualizarIto(t){const e=t.dataset.registroId,s=t.value,i=t.closest("td"),r=i.querySelector(".ito-text");try{const a=document.querySelector("[name=csrfmiddlewaretoken]").value,n=this.tabla.row(i.closest("tr")).data(),o=await fetch(`${this.config.registrosUrl}${e}/`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRFToken":a},body:JSON.stringify({sitio_id:n.sitio.id,user_id:s,is_deleted:n.is_deleted})});if(!o.ok)throw new Error("Error en la actualización");const d=await o.json(),u=this.usuariosIto.find(g=>g.id==s);r.innerHTML=(u?u.username:"Sin asignar")+' <i class="fa-solid fa-pen-to-square text-xs text-gray-400 ml-1"></i>',t.style.display="none",r.style.display="inline",l.success("ITO actualizado exitosamente",{autoHide:3e3,dismissible:!0})}catch(a){console.error("Error:",a);const n=this.tabla.row(i.closest("tr")).data(),o=this.usuariosIto.find(d=>d.id==n.user.id);r.innerHTML=(o?o.username:"Sin asignar")+' <i class="fa-solid fa-pen-to-square text-xs text-gray-400 ml-1"></i>',t.style.display="none",r.style.display="inline",l.error("Error al actualizar ITO. Por favor, inténtalo de nuevo.",{autoHide:0,dismissible:!0})}}}class w{constructor(t={}){this.config={modalId:window.MODAL_ID||"#activar-registro-modal",activarBtnId:window.ACTIVAR_BTN_ID||"#activar-registro-btn",activarUrl:window.ACTIVAR_URL||"/txtss/activar/",...t},this.modal=null,this.activarBtn=null,this.init()}init(){this.modal=document.getElementById(this.config.modalId.replace("#","")),this.activarBtn=document.getElementById(this.config.activarBtnId.replace("#","")),this.activarBtn&&this.modal&&this.configurarEventos()}configurarEventos(){this.activarBtn.addEventListener("click",()=>{this.modal.showModal()}),window.closeModal=()=>{this.modal.close()};const t=this.modal.querySelector("form");t&&t.addEventListener("submit",e=>this.handleFormSubmit(e))}async handleFormSubmit(t){t.preventDefault();const e=new FormData(t.target);e.get("sitio"),e.get("user");try{const s=document.querySelector("[name=csrfmiddlewaretoken]").value,i=await fetch(this.config.activarUrl,{method:"POST",headers:{"X-CSRFToken":s,"X-Requested-With":"XMLHttpRequest"},body:e});if(!i.ok)throw new Error("Error en la petición");const r=await i.json();if(r.success)this.modal.close(),l.success(r.message||"Registro activado exitosamente",{autoHide:3e3}),setTimeout(()=>{window.location.reload()},1e3);else throw new Error(r.message||"Error al activar el registro")}catch(s){console.error("Error:",s),l.error("Error al crear el registro. Por favor, inténtalo de nuevo.",{autoHide:0,dismissible:!0})}}}document.addEventListener("DOMContentLoaded",function(){new m,new w});
